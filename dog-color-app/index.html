<!-- ▼▼▼ ここから：写真プレビュー枠（UI） ▼▼▼ -->
<section class="card" id="photoSection" style="margin-top:16px;">
  <h2>愛犬写真の背景除去＆3色プレビュー</h2>
  <p class="hint" style="color:#555; background:#f6f7f8; padding:8px 10px; border-radius:8px;">
    画像をアップロードすると背景を自動で除去し、診断の3色背景でプレビューできます
  </p>

  <input id="upload" type="file" accept="image/*" />
  <div id="upMsg" class="note" style="margin-top:8px; display:none;"></div>

  <div id="previewArea" style="display:none; margin-top:12px;">
    <div style="display:grid; gap:12px;">
      <canvas id="cvMain" width="900" height="900" style="max-width:100%; border:1px solid #eee; border-radius:8px;"></canvas>
      <canvas id="cvSub"  width="900" height="900" style="max-width:100%; border:1px solid #eee; border-radius:8px;"></canvas>
      <canvas id="cvAcc"  width="900" height="900" style="max-width:100%; border:1px solid #eee; border-radius:8px;"></canvas>
    </div>
    <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn" id="dlMain" style="padding:10px 14px; border-radius:8px; border:1px solid #ddd;">メイン色背景をダウンロード</button>
      <button class="btn" id="dlSub"  style="padding:10px 14px; border-radius:8px; border:1px solid #ddd;">サブ色背景をダウンロード</button>
      <button class="btn" id="dlAcc"  style="padding:10px 14px; border-radius:8px; border:1px solid #ddd;">アクセント色背景をダウンロード</button>
    </div>
  </div>
</section>
<!-- ▲▲▲ ここまで：写真プレビュー枠（UI） ▲▲▲ -->

<!-- ▼▼▼ ここから：写真処理モジュール（1回だけ定義） ▼▼▼ -->
<script id="dog-photo-module">
(() => {
  // 二重読み込み防止
  if (window.__DOG_PHOTO_MODULE_LOADED__) return;
  window.__DOG_PHOTO_MODULE_LOADED__ = true;

  /* ========= ユーティリティ ========= */
  const $  = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  function setUpMsg(text, show = true) {
    const el = $('#upMsg');
    if (!el) return;
    el.textContent = text || '';
    el.style.display = show ? 'block' : 'none';
  }

  function currentResultHexes() {
    const m = $('#mainHex')?.textContent.trim();
    const s = $('#subHex')?.textContent.trim();
    const a = $('#accHex')?.textContent.trim();
    if (!m || m === '—' || !s || s === '—' || !a || a === '—') return null;
    return { main: m, sub: s, acc: a };
  }

  // File -> Base64(ヘッダなしの生データ)
  async function fileToBase64Binary(file) {
    const buf = await file.arrayBuffer();
    let binary = '';
    const bytes = new Uint8Array(buf);
    const chunk = 0x8000;
    for (let i = 0; i < bytes.length; i += chunk) {
      binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
    }
    return btoa(binary);
  }

  function loadImageFromBlob(blob) {
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(blob);
      const im  = new Image();
      im.onload = () => { URL.revokeObjectURL(url); resolve(im); };
      im.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
      im.src = url;
    });
  }

  // 単色背景に切り抜き画像を中央配置で描画
  function drawComposite(canvas, bgHex, subjectImg) {
    if (!canvas) throw new Error('canvas not found');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = bgHex;
    ctx.fillRect(0, 0, W, H);

    // 余白を5%確保しつつ中央フィット
    const pad  = 0.05;
    const maxW = W * (1 - 2 * pad);
    const maxH = H * (1 - 2 * pad);
    const scale = Math.min(maxW / subjectImg.width, maxH / subjectImg.height);
    const dw = subjectImg.width * scale;
    const dh = subjectImg.height * scale;
    const dx = (W - dw) / 2;
    const dy = (H - dh) / 2;

    ctx.shadowColor = 'rgba(0,0,0,0.15)';
    ctx.shadowBlur  = Math.round(W * 0.02);
    ctx.drawImage(subjectImg, dx, dy, dw, dh);
    ctx.shadowBlur = 0;
  }

  // ダウンロード（iOSも考慮）
  function downloadCanvas(canvas, filename) {
    const dataUrl = canvas.toDataURL('image/png');
    const isIOS =
      /iP(hone|ad|od)/.test(navigator.platform) ||
      (navigator.userAgent.includes('Mac') && 'ontouchend' in document);

    if (isIOS) {
      const w = window.open();
      if (w) {
        w.document.write('<html><head><title>長押しで保存</title></head><body style="margin:0">');
        w.document.write(`<img src="${dataUrl}" style="width:100%;height:auto;display:block">`);
        w.document.write('</body></html>');
        w.document.close();
      } else {
        const a = document.createElement('a');
        a.href = dataUrl;
        a.target = '_blank';
        document.body.appendChild(a); a.click(); a.remove();
      }
    } else {
      const a = document.createElement('a');
      a.download = filename;
      a.href = dataUrl;
      document.body.appendChild(a); a.click(); a.remove();
    }
  }

  // 背景除去API呼び出し（/api/remove-bg が PNG を返す想定）
  async function removeBackgroundByJsonBase64(file) {
    // 形式・サイズの簡易チェック
    if (!/^image\/(png|jpe?g|webp)$/i.test(file.type || '')) {
      throw new Error('UNSUPPORTED_CLIENT_TYPE');
    }
    if (file.size > 4 * 1024 * 1024) {
      throw new Error('FILE_TOO_LARGE_CLIENT'); // 4MB目安
    }

    const base64 = await fileToBase64Binary(file);

    const res = await fetch('/api/remove-bg', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        filename: file.name || 'image.jpg',
        mime: file.type || 'image/jpeg',
        data: base64
      })
    });

    if (!res.ok) {
      // サーバーの詳細を拾って表示
      let detail = '';
      try {
        const j = await res.json();
        detail = j?.detail || JSON.stringify(j);
      } catch {}
      throw new Error(`SERVER_${res.status}: ${detail || 'UNKNOWN'}`);
    }

    return await res.blob(); // ← PNG が返ってくる
  }

  /* ========= 入口：アップロード ========= */
  // 既存の重複リスナーを避けるため、一度 input をクローンして差し替え
  const oldInput = $('#upload');
  if (!oldInput) return;
  const freshInput = oldInput.cloneNode(true);
  oldInput.replaceWith(freshInput);

  freshInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // 診断済みかチェック
    const hexes = currentResultHexes();
    if (!hexes) {
      setUpMsg('先に診断を実行して、3色を確定してください。', true);
      return;
    }

    try {
      setUpMsg('背景を削除中…（数秒かかります）', true);

      // 背景除去→PNG Blob
      const pngBlob = await removeBackgroundByJsonBase64(file);

      // 画像読み込み
      const subject = await loadImageFromBlob(pngBlob);

      // 合成して表示
      drawComposite($('#cvMain'), hexes.main, subject);
      drawComposite($('#cvSub'),  hexes.sub,  subject);
      drawComposite($('#cvAcc'),  hexes.acc,  subject);

      $('#previewArea').style.display = 'block';
      setUpMsg('プレビューを表示しました。各ボタンから保存できます。', true);
    } catch (err) {
      console.error(err);
      // わかる範囲で詳細を出す
      const msg = String(err && err.message || err || 'Unknown error');
      setUpMsg('背景除去に失敗しました：' + msg, true);
    }
  });

  // ダウンロードボタン（1回だけバインド）
  const dlMain = $('#dlMain');
  const dlSub  = $('#dlSub');
  const dlAcc  = $('#dlAcc');
  if (dlMain) dlMain.onclick = () => downloadCanvas($('#cvMain'), 'main.png');
  if (dlSub)  dlSub.onclick  = () => downloadCanvas($('#cvSub'),  'sub.png');
  if (dlAcc)  dlAcc.onclick  = () => downloadCanvas($('#cvAcc'),  'accent.png');
})();
</script>
<!-- ▲▲▲ ここまで：写真処理モジュール ▲▲▲ -->
