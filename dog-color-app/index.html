<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ„›çŠ¬ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼è¨ºæ–­</title>
<style>
  :root{--ink:#222;--muted:#667085;--bg:#f7f7f9;--panel:#fff;--brand:#2d9cdb}
  *{box-sizing:border-box}
  body{margin:0;font:15px/1.55 system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:var(--ink)}
  header{padding:18px 14px;text-align:center;background:#fff;border-bottom:1px solid #eee}
  h1{margin:0 0 6px;font-size:20px}
  .subtitle{font-size:13px;color:#666;line-height:1.5}
  .app{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:14px}
  @media(min-width:900px){.app{grid-template-columns:1.2fr 1fr}}
  .card{background:var(--panel);border:1px solid #e9eaee;border-radius:12px;padding:14px}
  h2{margin:0 0 8px;font-size:16px}
  .hint{font-size:12px;color:var(--muted);display:flex;gap:6px;align-items:flex-start}
  .hint::before{content:"â“˜";display:inline-block;line-height:1;border-radius:50%;font-size:12px;color:#4a77a8}
  .coat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .coat{border:1px solid #e6e7eb;border-radius:10px;overflow:hidden;background:#fff;cursor:pointer}
  .coat .chip{height:46px}
  .coat .meta{padding:6px 8px;font-size:13px;display:flex;justify-content:space-between;align-items:center;gap:6px}
  .coat .meta span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0}
  .coat small{color:#6c727f}
  .coat.selected{outline:3px solid #8ccdf5;border-color:#8ccdf5}
  .traits{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  .group{border:1px solid #eee;border-radius:10px;padding:8px}
  .group h3{margin:0 0 6px;font-size:12px;color:var(--muted)}
  .traits-list label{display:flex;align-items:center;gap:6px;padding:3px 4px;border-radius:6px}
  .traits-list label:hover{background:#f6f7f9}
  .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn{border:0;border-radius:999px;padding:9px 14px;font-weight:700;cursor:pointer}
  .primary{background:var(--brand);color:#fff}
  .ghost{background:#f1f3f5;color:#333}
  .err{color:#b00020;font-size:13px;margin-top:6px;display:none}
  .note{color:#b26b00;font-size:12px;margin-top:6px;display:none}
  .swatches{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .sw{border:1px solid #e6e6e6;border-radius:12px;overflow:hidden;background:#fff}
  .sw .chip{height:70px}
  .sw .meta{padding:8px 10px}
  .sw .ttl{font-weight:700;font-size:13px}
  .rowsm{display:flex;justify-content:space-between;align-items:center;margin-top:2px}
  .rowsm code{background:#f2f4f7;border-radius:6px;padding:2px 6px}
  .badge{display:none} /* ãƒˆãƒ¼ãƒ³éè¡¨ç¤º */

  /* ã‚¹ãƒ”ãƒŠãƒ¼ */
  .spinner{display:none;gap:8px;align-items:center;font-size:13px;color:#555}
  .spinner .dot{width:8px;height:8px;border-radius:50%;background:#999;animation:b 0.9s infinite alternate}
  .spinner .dot:nth-child(2){animation-delay:0.15s}.spinner .dot:nth-child(3){animation-delay:0.3s}
  @keyframes b{to{opacity:0.2;transform:translateY(-2px)}}

  /* === Mobile === */
  @media (max-width: 640px) {
    .app { grid-template-columns: 1fr; padding: 10px; }
    .coat-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .coat .chip { height: 56px; }
    .coat .meta { font-size: 12px; padding: 5px 7px; }
    .coat .meta small { display:none; } /* HEXéš ã—ã¦1è¡Œä¿æŒ */
    .traits { grid-template-columns: 1fr; gap: 10px; }
    .traits-list label { padding: 8px 10px; }
    .traits-list input[type="checkbox"] { transform: scale(1.25); }
    .btn { width: auto; padding: 12px 14px; font-size: 15px; }
    .swatches { grid-template-columns: 1fr; gap: 12px; }
    .sw .chip { height: 84px; }
    .sw .meta { padding: 10px 12px; }
    .rowsm code { font-size: 12px; }
    body { font-size: 16px; }
  }
  .coat, .btn, .traits-list label { min-height: 44px; }
</style>
</head>
<body>
<header>
  <h1>æ„›çŠ¬ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼è¨ºæ–­</h1>
  <div class="subtitle">
    åˆè¨ˆ27,000é€šã‚Šã®æ¯›è‰²Ã—æ€§æ ¼ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰ã€<br>
    æ„›çŠ¬ã«ä¼¼åˆã†3è‰²ã‚’è¨ºæ–­ã—ã¾ã™
  </div>
</header>

<div class="app">
  <!-- å·¦ï¼šå…¥åŠ› -->
  <section class="card">
    <h2>1) æ„›çŠ¬ã®æ¯›è‰²ã‚’é¸æŠ</h2>
    <p class="hint">1è‰²ã®ã¿é¸æŠã—ã¦ãã ã•ã„ã€‚(æ¯›ãŒ2è‰²ã®å ´åˆã¯ãƒ¡ã‚¤ãƒ³ã®è‰²ã‚’é¸æŠ)</p>
    <div id="coatGrid" class="coat-grid" aria-label="æ¯›è‰²ä¸€è¦§"></div>

    <h2 style="margin-top:14px">2) æ„›çŠ¬ã®æ€§æ ¼ã‚’1ï½3ã¤ã¾ã§é¸æŠ</h2>
    <p class="hint">å„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‹ã‚‰1ã¤ãšã¤é¸ã¶ã“ã¨ã‚‚ã€1ã¤ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‹ã‚‰3ã¤é¸ã¶ã“ã¨ã‚‚ã§ãã¾ã™</p>
    <div class="traits">
      <div class="group"><h3>å†…å‘çš„</h3><div id="traits-intro" class="traits-list"></div></div>
      <div class="group"><h3>ä¸­ç«‹çš„</h3><div id="traits-neutral" class="traits-list"></div></div>
      <div class="group"><h3>å¤–äº¤çš„</h3><div id="traits-extro" class="traits-list"></div></div>
    </div>

    <div class="actions">
      <button class="btn primary" id="run">è¨ºæ–­ã™ã‚‹</button>
      <button class="btn ghost" id="reset">ãƒªã‚»ãƒƒãƒˆ</button>
      <div id="msg" class="err"></div>
      <div id="note" class="note">æ€§æ ¼ã¯1ã€œ3ã¤ã¾ã§é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
    </div>
  </section>

  <!-- å³ï¼šçµæœ -->
  <section class="card">
    <h2>æ„›çŠ¬ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼è¨ºæ–­çµæœ</h2>
    <p class="hint">
      ãƒ¡ã‚¤ãƒ³ï¼šä¸»ã«æ„›çŠ¬ã®æ¯›ã®è‰²ã‹ã‚‰ä¼¼åˆã†è‰²ã‚’è¨ºæ–­<br>
      ã‚µãƒ–ï¼šæ„›çŠ¬ã®æ€§æ ¼ã‚’åŠ å‘³ã—ãŸä¸Šã§è¨ºæ–­<br>
      ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼šæ¯›ã®è‰²ã¨ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã«ã‚ˆã‚Šã€ç›®ç«‹ã¤è‰²ã‚’è¨ºæ–­
    </p>
    <div class="swatches">
      <div class="sw">
        <div class="chip" id="mainChip" style="background:#fff"></div>
        <div class="meta">
          <div class="ttl">ãƒ¡ã‚¤ãƒ³ <span class="badge" id="mainTone">â€”</span></div>
          <div class="rowsm"><span id="mainName">â€”</span><code id="mainHex">â€”</code></div>
        </div>
      </div>
      <div class="sw">
        <div class="chip" id="subChip" style="background:#fff"></div>
        <div class="meta">
          <div class="ttl">ã‚µãƒ– <span class="badge" id="subTone">â€”</span></div>
          <div class="rowsm"><span id="subName">â€”</span><code id="subHex">â€”</code></div>
        </div>
      </div>
      <div class="sw">
        <div class="chip" id="accChip" style="background:#fff"></div>
        <div class="meta">
          <div class="ttl">ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ <span class="badge" id="accTone">â€”</span></div>
          <div class="rowsm"><span id="accName">â€”</span><code id="accHex">â€”</code></div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
<section class="card" id="photoSection" style="margin:16px auto;max-width:1100px;">
  <h2>æ„›çŠ¬å†™çœŸã®èƒŒæ™¯é™¤å»ï¼†3è‰²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
  <p class="hint" style="color:#555; background:#f6f7f8; padding:8px 10px; border-radius:8px;">
    ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨èƒŒæ™¯ã‚’è‡ªå‹•ã§é™¤å»ã—ã€è¨ºæ–­ã®3è‰²èƒŒæ™¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã™
  </p>

  <input id="upload" type="file" accept="image/png,image/jpeg,image/webp" />
  <div class="spinner" id="spin">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    <span>èƒŒæ™¯ã‚’å‰Šé™¤ä¸­â€¦</span>
  </div>
  <div id="upMsg" class="note" style="margin-top:8px;display:none;"></div>

  <div id="previewArea" style="display:none; margin-top:12px;">
    <div style="display:grid; gap:12px;">
      <canvas id="cvMain" width="900" height="900" style="max-width:100%;border:1px solid #eee;border-radius:8px;"></canvas>
      <canvas id="cvSub"  width="900" height="900" style="max-width:100%;border:1px solid #eee;border-radius:8px;"></canvas>
      <canvas id="cvAcc"  width="900" height="900" style="max-width:100%;border:1px solid #eee;border-radius:8px;"></canvas>
    </div>
    <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn" id="dlMain">ãƒ¡ã‚¤ãƒ³è‰²èƒŒæ™¯ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button class="btn" id="dlSub" >ã‚µãƒ–è‰²èƒŒæ™¯ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button class="btn" id="dlAcc" >ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰²èƒŒæ™¯ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button class="btn" id="btnShare">SNSã§ã‚·ã‚§ã‚¢</button>
      <button class="btn ghost" id="btnClaim" disabled>ã‚·ã‚§ã‚¢å®Œäº†ï¼1ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå—ã‘å–ã‚‹</button>
      <span id="creditInfo" style="font-size:12px;color:#667085;"></span>
    </div>
  </div>
</section>

<!-- ã“ã“ã‹ã‚‰JSï¼ˆUIï¼‹è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ï¼‹å†™çœŸï¼†ã‚·ã‚§ã‚¢ï¼‰ -->
<script>
/* ===== 70è‰²ãƒ‘ãƒ¬ãƒƒãƒˆ ===== */
const PALETTE=[
  {hex:"#F5F5DC",cat:"ãƒ™ãƒ¼ã‚¸ãƒ¥",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ™ãƒ¼ã‚¸ãƒ¥VL"},
  {hex:"#E4CDA7",cat:"ãƒ™ãƒ¼ã‚¸ãƒ¥",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ™ãƒ¼ã‚¸ãƒ¥L"},
  {hex:"#D2B48C",cat:"ãƒ™ãƒ¼ã‚¸ãƒ¥",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚¿ãƒ³"},
  {hex:"#C3A276",cat:"ãƒ™ãƒ¼ã‚¸ãƒ¥",tone:"ãƒ€ãƒ¼ã‚¯",name:"ã‚­ãƒ£ãƒ¡ãƒ«"},
  {hex:"#FFFF99",cat:"é»„è‰²",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ©ã‚¤ãƒˆã‚¤ã‚¨ãƒ­ãƒ¼"},
  {hex:"#FFFF00",cat:"é»„è‰²",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚¤ã‚¨ãƒ­ãƒ¼"},
  {hex:"#DFFF00",cat:"é»„è‰²",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ©ã‚¤ãƒ ã‚¤ã‚¨ãƒ­ãƒ¼"},
  {hex:"#FFEF00",cat:"é»„è‰²",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚«ãƒŠãƒªã‚¢"},
  {hex:"#FFD166",cat:"é»„è‰²",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒãƒ‹ãƒ¼"},
  {hex:"#F2C94C",cat:"é»„è‰²",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³"},
  {hex:"#FFBF00",cat:"ã‚ªãƒ¬ãƒ³ã‚¸",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚¢ãƒ³ãƒãƒ¼"},
  {hex:"#FF7F00",cat:"ã‚ªãƒ¬ãƒ³ã‚¸",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚ªãƒ¬ãƒ³ã‚¸"},
  {hex:"#FF6700",cat:"ã‚ªãƒ¬ãƒ³ã‚¸",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚¿ãƒ³ã‚¸ã‚§ãƒªãƒ³"},
  {hex:"#FF6347",cat:"ã‚ªãƒ¬ãƒ³ã‚¸",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒˆãƒãƒˆ"},
  {hex:"#FADADD",cat:"ãƒ”ãƒ³ã‚¯",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ­ãƒ¼ã‚ºãƒŸã‚¹ãƒˆ"},
  {hex:"#FBCEB1",cat:"ãƒ”ãƒ³ã‚¯",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ”ãƒ¼ãƒ"},
  {hex:"#FFA8A8",cat:"ãƒ”ãƒ³ã‚¯",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ™ãƒ“ãƒ¼ãƒ”ãƒ³ã‚¯"},
  {hex:"#F88379",cat:"ãƒ”ãƒ³ã‚¯",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚³ãƒ¼ãƒ©ãƒ«"},
  {hex:"#E07A5F",cat:"ãƒ”ãƒ³ã‚¯",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ†ãƒ©ã‚³ãƒƒã‚¿P"},
  {hex:"#FF69B4",cat:"ãƒ”ãƒ³ã‚¯",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ›ãƒƒãƒˆãƒ”ãƒ³ã‚¯"},
  {hex:"#FF4F9A",cat:"ãƒ”ãƒ³ã‚¯",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ“ãƒ“ãƒƒãƒ‰ãƒ”ãƒ³ã‚¯"},
  {hex:"#FF00FF",cat:"ãƒ”ãƒ³ã‚¯",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒã‚¼ãƒ³ã‚¿"},
  {hex:"#FF1493",cat:"ãƒ”ãƒ³ã‚¯",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ”ãƒ³ã‚¯"},
  {hex:"#C21E56",cat:"èµ¤",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ«ãƒ“ãƒ¼"},
  {hex:"#D81B60",cat:"èµ¤",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ©ã‚ºãƒ™ãƒªãƒ¼"},
  {hex:"#FF0000",cat:"èµ¤",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ¬ãƒƒãƒ‰"},
  {hex:"#800020",cat:"èµ¤",tone:"ãƒ€ãƒ¼ã‚¯",name:"ãƒãƒ¼ã‚¬ãƒ³ãƒ‡ã‚£"},
  {hex:"#98FFCC",cat:"ç·‘",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒŸãƒ³ãƒˆ"},
  {hex:"#93C572",cat:"ç·‘",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ”ã‚¹ã‚¿ãƒã‚ª"},
  {hex:"#00FF7F",cat:"ç·‘",tone:"ãƒ©ã‚¤ãƒˆ",name:"ã‚¹ãƒ—ãƒªãƒ³ã‚°G"},
  {hex:"#00FF00",cat:"ç·‘",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ©ã‚¤ãƒ "},
  {hex:"#4CBB17",cat:"ç·‘",tone:"ãƒ©ã‚¤ãƒˆ",name:"ã‚±ãƒªãƒ¼"},
  {hex:"#00A550",cat:"ç·‘",tone:"ãƒ©ã‚¤ãƒˆ",name:"ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰"},
  {hex:"#6B8E23",cat:"ç·‘",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚ªãƒªãƒ¼ãƒ–ãƒ‰ãƒ©ãƒ–"},
  {hex:"#228B22",cat:"ç·‘",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ"},
  {hex:"#556B2F",cat:"ç·‘",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ€ãƒ¼ã‚¯ã‚ªãƒªãƒ¼ãƒ–"},
  {hex:"#4B5320",cat:"ç·‘",tone:"ãƒ€ãƒ¼ã‚¯",name:"ã‚¢ãƒ¼ãƒŸãƒ¼G"},
  {hex:"#AFEEEE",cat:"é’",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ‘ã‚¦ãƒ€ãƒ¼ãƒ–ãƒ«ãƒ¼"},
  {hex:"#ADD8E6",cat:"é’",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼"},
  {hex:"#00FFFF",cat:"é’",tone:"ãƒ©ã‚¤ãƒˆ",name:"ã‚·ã‚¢ãƒ³"},
  {hex:"#2D9CDB",cat:"é’",tone:"ãƒ©ã‚¤ãƒˆ",name:"ã‚¹ã‚«ã‚¤"},
  {hex:"#4682B4",cat:"é’",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚¹ãƒãƒ¼ãƒ«"},
  {hex:"#2EC4B6",cat:"é’",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚¿ãƒ¼ã‚³ã‚¤ã‚º"},
  {hex:"#1B7F79",cat:"é’",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ†ã‚£ãƒ¼ãƒ«"},
  {hex:"#2F5DCC",cat:"é’",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ­ã‚¤ãƒ¤ãƒ«"},
  {hex:"#0047AB",cat:"é’",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚³ãƒãƒ«ãƒˆ"},
  {hex:"#0000FF",cat:"é’",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ–ãƒ«ãƒ¼"},
  {hex:"#1F2A44",cat:"é’",tone:"ãƒ€ãƒ¼ã‚¯",name:"ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆ"},
  {hex:"#191970",cat:"é’",tone:"ãƒ€ãƒ¼ã‚¯",name:"ãƒã‚¤ãƒ“ãƒ¼"},
  {hex:"#CCCCFF",cat:"ç´«",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒšãƒ¼ãƒ«ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼"},
  {hex:"#C8A2C8",cat:"ç´«",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ©ã‚¤ãƒ©ãƒƒã‚¯"},
  {hex:"#B57EDC",cat:"ç´«",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼"},
  {hex:"#8E4585",cat:"ç´«",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ—ãƒ©ãƒ "},
  {hex:"#8F00FF",cat:"ç´«",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯P"},
  {hex:"#4B0082",cat:"ç´«",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚¤ãƒ³ãƒ‡ã‚£ã‚´"},
  {hex:"#C19A6B",cat:"ãƒ–ãƒ©ã‚¦ãƒ³",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ©ã‚¤ãƒˆãƒ–ãƒ©ã‚¦ãƒ³"},
  {hex:"#B6864D",cat:"ãƒ–ãƒ©ã‚¦ãƒ³",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒŸãƒ‰ãƒ«ãƒ–ãƒ©ã‚¦ãƒ³"},
  {hex:"#CD7F32",cat:"ãƒ–ãƒ©ã‚¦ãƒ³",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ–ãƒ­ãƒ³ã‚º"},
  {hex:"#A0522D",cat:"ãƒ–ãƒ©ã‚¦ãƒ³",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚»ãƒ”ã‚¢"},
  {hex:"#C04000",cat:"ãƒ–ãƒ©ã‚¦ãƒ³",tone:"ãƒ€ãƒ¼ã‚¯",name:"ãƒ©ã‚»ãƒƒãƒˆ"},
  {hex:"#722F37",cat:"ãƒ–ãƒ©ã‚¦ãƒ³",tone:"ãƒ€ãƒ¼ã‚¯",name:"ãƒãƒ«ãƒ¼ãƒ³B"},
  {hex:"#483C32",cat:"ãƒ–ãƒ©ã‚¦ãƒ³",tone:"ãƒ€ãƒ¼ã‚¯",name:"ãƒ€ãƒ¼ã‚¯ãƒˆãƒ¼ãƒ—"},
  {hex:"#D6D6D6",cat:"ã‚°ãƒ¬ãƒ¼",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼"},
  {hex:"#A9A9A9",cat:"ã‚°ãƒ¬ãƒ¼",tone:"ãƒ©ã‚¤ãƒˆ",name:"ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼(æ˜)"},
  {hex:"#808080",cat:"ã‚°ãƒ¬ãƒ¼",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚°ãƒ¬ãƒ¼"},
  {hex:"#696969",cat:"ã‚°ãƒ¬ãƒ¼",tone:"ãƒŸãƒ‰ãƒ«",name:"ãƒ‡ã‚£ãƒ ã‚°ãƒ¬ãƒ¼"},
  {hex:"#708090",cat:"ã‚°ãƒ¬ãƒ¼",tone:"ãƒŸãƒ‰ãƒ«",name:"ã‚¹ãƒ¬ãƒ¼ãƒˆã‚°ãƒ¬ãƒ¼"},
  {hex:"#36454F",cat:"ã‚°ãƒ¬ãƒ¼",tone:"ãƒ€ãƒ¼ã‚¯",name:"ãƒãƒ£ã‚³ãƒ¼ãƒ«"},
  {hex:"#1E1E1E",cat:"ã‚°ãƒ¬ãƒ¼",tone:"ãƒ€ãƒ¼ã‚¯",name:"ã‚¸ã‚§ãƒƒãƒˆ"},
  {hex:"#000000",cat:"ã‚°ãƒ¬ãƒ¼",tone:"ãƒ€ãƒ¼ã‚¯",name:"ãƒ–ãƒ©ãƒƒã‚¯"}
];

/* ===== æ¯›è‰²20ï¼ˆè‰²è¦‹æœ¬ä»˜ãï¼‰ ===== */
const COATS=[
  ["ãƒ›ãƒ¯ã‚¤ãƒˆ","#FFFFFF"],["ã‚¯ãƒªãƒ¼ãƒ ","#FFFDD0"],["ãƒ•ã‚©ãƒ¼ãƒ³","#C3A276"],["ã‚¿ãƒ³","#C49A6C"],["ã‚»ãƒ¼ãƒ–ãƒ«","#7B5B3E"],["ã‚¢ãƒ—ãƒªã‚³ãƒƒãƒˆ","#E6A571"],
  ["ã‚¤ã‚¨ãƒ­ãƒ¼","#FFD54F"],["ã‚´ãƒ¼ãƒ«ãƒ‰","#FFD700"],["ãƒ¬ãƒƒãƒ‰","#C04000"],["ãƒãƒ›ã‚¬ãƒ‹ãƒ¼","#722F37"],
  ["ãƒãƒ¼ãƒ«","#7A92A6"],["ãƒ–ãƒ«ãƒ¼","#5A7FA3"],["ã‚·ãƒ«ãƒãƒ¼","#A9A9A9"],["ã‚¦ãƒ«ãƒ•ã‚»ãƒ¼ãƒ–ãƒ«","#8E8E86"],["ã‚°ãƒ¬ãƒ¼","#808080"],
  ["ãƒ©ã‚¤ãƒˆãƒ–ãƒ©ã‚¦ãƒ³","#B6864D"],["ãƒ–ãƒ©ã‚¦ãƒ³","#8B5A2B"],["ãƒ–ãƒªãƒ³ãƒ‰ãƒ«","#5A4636"],["ãƒ€ãƒ¼ã‚¯ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ","#3A2C2A"],["ãƒ–ãƒ©ãƒƒã‚¯","#000000"]
];

/* ===== æ€§æ ¼ãƒªã‚¹ãƒˆ ===== */
const TRAITS={
  intro:["ç¹Šç´°","æ…é‡","è­¦æˆ’å¿ƒãŒå¼·ã„","å¯‚ã—ãŒã‚Šå±‹","ãŠã ã‚„ã‹","ãƒã‚¤ãƒšãƒ¼ã‚¹","ç‹¬ç«‹å¿ƒãŒå¼·ã„","é ‘å›º"],
  neutral:["è³¢ã„","é›†ä¸­åŠ›ãŒé«˜ã„","ã‚¯ãƒ¼ãƒ«","ç´ ç›´","å¥½å¥‡å¿ƒæ—ºç››","ç”˜ãˆã‚“åŠ","é †å¿œæ€§ãŒé«˜ã„"],
  extro:["å‹‡æ•¢","æ´»ç™º","ãŠèª¿å­è€…","ãƒªãƒ¼ãƒ€ãƒ¼æ°—è³ª","ç¤¾äº¤çš„"]
};

/* ===== è‰²ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const hexToRgb=h=>{const m=h.replace('#','');return{r:parseInt(m.slice(0,2),16),g:parseInt(m.slice(2,4),16),b:parseInt(m.slice(4,6),16)}};
const rgbToHue=({r,g,b})=>{r/=255;g/=255;b/=255;const mx=Math.max(r,g,b),mn=Math.min(r,g,b),d=mx-mn;if(d===0)return 0;let h=mx===r?(g-b)/d:mx===g?(b-r)/d+2:(r-g)/d+4;return (h*60+360)%360};
const hueOf=hex=>rgbToHue(hexToRgb(hex));
const hueDist=(a,b)=>{const d=Math.abs(a-b)%360;return d>180?360-d:d};
function rgbToXyz(r,g,b){r/=255;g/=255;b/=255;r=r>0.04045?((r+0.055)/1.055)**2.4:r/12.92;g=g>0.04045?((g+0.055)/1.055)**2.4:g/12.92;b=b>0.04045?((b+0.055)/1.055)**2.4:b/12.92;const x=r*0.4124+g*0.3576+b*0.1805;const y=r*0.2126+g*0.7152+b*0.0722;const z=r*0.0193+g*0.1192+b*0.9505;return{x:x*100,y:y*100,z:z*100}}
function xyzToLab(x,y,z){const xr=x/95.047,yr=y/100,zr=z/108.883;const f=t=>t>0.008856?Math.cbrt(t):(7.787*t+16/116);const fx=f(xr),fy=f(yr),fz=f(zr);return{L:116*fy-16,a:500*(fx-fy),b:200*(fy-fz)}}
const hexToLab=hex=>{const {r,g,b}=hexToRgb(hex);const {x,y,z}=rgbToXyz(r,g,b);return xyzToLab(x,y,z)};
function labChroma(hex){const L=hexToLab(hex);return Math.hypot(L.a,L.b);}

/* ===== æ€§æ ¼ â†’ ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆ ===== */
const traitGroup={}; 
TRAITS.intro.forEach(t=>traitGroup[t]="å†…å‘");
TRAITS.neutral.forEach(t=>traitGroup[t]="ä¸­ç«‹");
TRAITS.extro.forEach(t=>traitGroup[t]="å¤–äº¤");
function sentiment(traits){let s=0,n=0,e=0;traits.forEach(t=>{const g=traitGroup[t];if(g==="å†…å‘")s++;else if(g==="å¤–äº¤")e++;else n++;});if(e>=s&&e>=n)return"å¤–äº¤";if(s>=n&&s>=e)return"å†…å‘";return"ä¸­ç«‹"}
const tonePrefWeight={å†…å‘:{ãƒ©ã‚¤ãƒˆ:1.0,ãƒŸãƒ‰ãƒ«:0.7,ãƒ€ãƒ¼ã‚¯:0.3},ä¸­ç«‹:{ãƒ©ã‚¤ãƒˆ:0.7,ãƒŸãƒ‰ãƒ«:1.0,ãƒ€ãƒ¼ã‚¯:0.7},å¤–äº¤:{ãƒ©ã‚¤ãƒˆ:0.4,ãƒŸãƒ‰ãƒ«:0.9,ãƒ€ãƒ¼ã‚¯:1.0}};
const TRAIT_HUE_TILT={
  "ç¹Šç´°":[330,285], "æ…é‡":[30,210], "è­¦æˆ’å¿ƒãŒå¼·ã„":[30,210],
  "å¯‚ã—ãŒã‚Šå±‹":[330,270], "ãŠã ã‚„ã‹":[90,40], "ãƒã‚¤ãƒšãƒ¼ã‚¹":[40,210],
  "ç‹¬ç«‹å¿ƒãŒå¼·ã„":[270,210], "é ‘å›º":[20,0],
  "è³¢ã„":[210,220], "é›†ä¸­åŠ›ãŒé«˜ã„":[210,200], "ã‚¯ãƒ¼ãƒ«":[210,240],
  "ç´ ç›´":[120,60], "å¥½å¥‡å¿ƒæ—ºç››":[60,330], "ç”˜ãˆã‚“åŠ":[330,300],
  "é †å¿œæ€§ãŒé«˜ã„":[40,120],
  "å‹‡æ•¢":[0,30], "æ´»ç™º":[30,60], "ãŠèª¿å­è€…":[60,330],
  "ãƒªãƒ¼ãƒ€ãƒ¼æ°—è³ª":[270,0], "ç¤¾äº¤çš„":[60,30]
};
function hueBiasScore(colorHue, prefHues){
  if(!prefHues || !prefHues.length) return 0;
  let best=0; prefHues.forEach(h=>{ const d=hueDist(colorHue,h); best=Math.max(best, Math.exp(-(d*d)/(2*25*25))); });
  return best;
}

/* ===== ã‚·ãƒ¼ãƒ‰ä¹±æ•° ===== */
function seedFrom(str){let h=2166136261>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619);}return h>>>0}
function rng(seed){let s=seed>>>0;return ()=>{s=(s*1664525+1013904223)>>>0;return (s&0xffff)/0x10000};}

/* ===== è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ ===== */
function pickColors(coatName, traits){
  const coatHex = (new Map(COATS)).get(coatName) || "#FFFFFF";
  const coatHue = hueOf(coatHex);
  const senti = sentiment(traits);
  const r = rng(seedFrom(coatName + "|" + traits.slice().sort().join(",")));
  const favorGray = ["ã‚¯ãƒ¼ãƒ«","è³¢ã„","é›†ä¸­åŠ›ãŒé«˜ã„"].some(t => traits.includes(t));

  const comp = (coatHue+180)%360;
  const splits = [(coatHue+150)%360,(coatHue+210)%360];
  const splitPrimary = splits[Math.floor(r()*splits.length)];

  const scored = PALETTE.map(c=>{
    const H = hueOf(c.hex), L = hexToLab(c.hex).L, C = labChroma(c.hex);
    const sAnalog = Math.exp(-(hueDist(H,coatHue)**2)/(2*35*35));
    const sComp   = Math.exp(-(hueDist(H,comp)**2)/(2*25*25));
    const sSplit1 = Math.exp(-(hueDist(H,splitPrimary)**2)/(2*22*22));
    const sSplit2 = Math.exp(-(hueDist(H,(splitPrimary===splits[0]?splits[1]:splits[0]))**2)/(2*25*25));
    const sSplit  = Math.max(sSplit1,sSplit2);

    let bias=0; traits.forEach(t=>{ bias += hueBiasScore(H, TRAIT_HUE_TILT[t]); });
    bias /= Math.max(1, traits.length);

    const toneW = (tonePrefWeight[senti][c.tone]||0.6);

    const mainScore = (1.2*sAnalog + 0.6*bias) * (0.8 + 0.4*toneW);
    const subBase   = (0.9*sAnalog + 0.9*bias) * (0.7 + 0.6*toneW);

    const grayPenalty = Math.max(0, (20 - Math.min(C,20)) / 20);
    const grayFactor =
      favorGray ? (1 - 0.25*grayPenalty) :
      senti==="å¤–äº¤" ? (1 - 0.35*grayPenalty) :
      senti==="ä¸­ç«‹" ? (1 - 0.55*grayPenalty) :
                       (1 - 0.70*grayPenalty);

    const accentBase =
      (senti==="å¤–äº¤" ? (0.9*sSplit + 1.05*sComp) :
       senti==="å†…å‘" ? (1.1*sSplit + 0.6*sComp) :
                        (1.0*sSplit + 0.8*sComp))
      + 0.55*bias;

    const wiggle = 0.96 + 0.08*r();

    return {c, H, L, mainScore, subBase: subBase, accentRaw: accentBase*grayFactor*wiggle};
  });

  // MAIN
  const mainList=[...scored].sort((a,b)=>b.mainScore-a.mainScore);
  const mTop=mainList[0].mainScore, mNear=mainList.filter(x=>x.mainScore>=mTop*0.98);
  const main=(mNear[Math.floor(r()*mNear.length)]||mainList[0]).c;

  // SUBï¼ˆãƒ¡ã‚¤ãƒ³ã¨è¿‘ä¼¼ã—ã™ãã‚’å°‘ã—é¿ã‘ã‚‹ï¼‰
  const mainHue=hueOf(main.hex), mainL=hexToLab(main.hex).L;
  const subList=scored.filter(x=>x.c.hex!==main.hex).map(x=>{
      const huePenalty = Math.exp(-(hueDist(x.H, mainHue)**2)/(2*20*20));
      const lightPenalty = Math.exp(-((x.L-mainL)**2)/(2*8*8));
      const diversityPenalty = 0.35*huePenalty + 0.25*lightPenalty;
      return {x, score: x.subBase*(1 - diversityPenalty)};
    }).sort((a,b)=>b.score-a.score);
  const sTop=subList[0].score, sNear=subList.filter(s=>s.score>=sTop*0.97);
  const sub=(sNear[Math.floor(r()*sNear.length)]||subList[0]).x.c;

  // ACCENTï¼ˆãƒ¡ã‚¤ãƒ³ãƒ»ã‚µãƒ–ã¨åŒç³»çµ±ã‚’ã‚„ã‚„æŠ‘åˆ¶ã€é’/ã‚°ãƒ¬ãƒ¼åã‚Šç·©å’Œï¼‰
  const usedCats=new Set([main.cat||main.c?.cat, sub.cat||sub.c?.cat].filter(Boolean));
  const subHue=hueOf(sub.hex);
  const accentList=scored
    .filter(x=>x.c.hex!==main.hex && x.c.hex!==sub.hex)
    .map(x=>{
      const nearMain = Math.exp(-(hueDist(x.H, mainHue)**2)/(2*18*18));
      const nearSub  = Math.exp(-(hueDist(x.H, subHue )**2)/(2*18*18));
      let score = x.accentRaw * (1 - (0.35*nearMain + 0.25*nearSub));
      if(usedCats.has(x.c.cat)) score *= 0.82;
      if(x.c.cat==="é’") score *= 0.93;
      if(x.c.cat==="ã‚°ãƒ¬ãƒ¼") score *= 0.85;
      return {x, score};
    })
    .sort((a,b)=>b.score-a.score);
  const aTop=accentList[0].score, aNear=accentList.filter(s=>s.score>=aTop*0.96);
  const accent=(aNear[Math.floor(r()*aNear.length)]||accentList[0]).x.c;

  return {main, sub, accent};
}

/* ===== UIæç”» ===== */
const coatGrid=document.getElementById("coatGrid");
let selectedCoat=null;
function renderCoats(){
  coatGrid.innerHTML="";
  COATS.forEach(([name,hex])=>{
    const card=document.createElement("button");
    card.type="button"; card.className="coat";
    card.innerHTML=`<div class="chip" style="background:${hex}"></div>
                    <div class="meta"><span>${name}</span><small>${hex}</small></div>`;
    card.addEventListener("click",()=>{
      selectedCoat=name;
      document.querySelectorAll(".coat").forEach(c=>c.classList.remove("selected"));
      card.classList.add("selected");
    });
    coatGrid.appendChild(card);
  });
}
renderCoats();

/* æ€§æ ¼ãƒªã‚¹ãƒˆæç”»ï¼‹åˆ¶é™ï¼ˆ1ã€œ3ã¤ï¼‰ */
function addTraitList(containerId, list){
  const el=document.getElementById(containerId);
  list.forEach(t=>{
    const wrap=document.createElement("label");
    const cb=document.createElement("input"); cb.type="checkbox"; cb.value=t;
    cb.addEventListener("change",limitTraits);
    wrap.appendChild(cb); wrap.appendChild(document.createTextNode(" "+t));
    el.appendChild(wrap);
  });
}
addTraitList("traits-intro", TRAITS.intro);
addTraitList("traits-neutral", TRAITS.neutral);
addTraitList("traits-extro", TRAITS.extro);

function selectedTraits(){ return [...document.querySelectorAll(".traits input[type=checkbox]:checked")].map(i=>i.value); }
function limitTraits(e){
  const checks=[...document.querySelectorAll(".traits input[type=checkbox]")];
  const checked=checks.filter(c=>c.checked);
  const note=document.getElementById("note");
  if(checked.length>3){
    e.target.checked=false;
    note.style.display="block";
    setTimeout(()=>note.style.display="none",1400);
  }
}

/* çµæœæç”» */
function setSw(prefix, color){
  document.getElementById(prefix+"Chip").style.background=color.hex;
  document.getElementById(prefix+"Hex").textContent=color.hex;
  document.getElementById(prefix+"Name").textContent=color.name;
  document.getElementById(prefix+"Tone").textContent=color.tone;
}

/* è¨ºæ–­å®Ÿè¡Œï¼šæ¯›è‰²å¿…é ˆãƒ»æ€§æ ¼1ã€œ3ã¤å¿…é ˆ */
function run(){
  const msg=document.getElementById("msg");
  const traits=selectedTraits();
  if(!selectedCoat){ msg.textContent="æ¯›è‰²ã‚’1ã¤é¸æŠã—ã¦ãã ã•ã„ã€‚"; msg.style.display="block"; return; }
  if(traits.length===0){ msg.textContent="æ€§æ ¼ã¯1ã€œ3ã¤ã¾ã§é¸æŠã—ã¦ãã ã•ã„ã€‚"; msg.style.display="block"; return; }
  msg.style.display="none";
  try{
    const res=pickColors(selectedCoat, traits);
    setSw("main",res.main); setSw("sub",res.sub); setSw("acc",res.accent);
  }catch(e){
    console.error(e);
    msg.textContent="ã‚¨ãƒ©ãƒ¼ï¼šå†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã«ä¸æ•´åˆãŒã‚ã‚Šã¾ã™ã€‚";
    msg.style.display="block";
  }
}
document.getElementById("run").addEventListener("click", run);

/* ãƒªã‚»ãƒƒãƒˆ */
document.getElementById("reset").addEventListener("click", ()=>{
  selectedCoat=null;
  document.querySelectorAll(".coat").forEach(c=>c.classList.remove("selected"));
  document.querySelectorAll(".traits input[type=checkbox]").forEach(c=>c.checked=false);
  ["main","sub","acc"].forEach(k=>{
    document.getElementById(k+"Chip").style.background="#fff";
    document.getElementById(k+"Hex").textContent="â€”";
    document.getElementById(k+"Name").textContent="â€”";
    document.getElementById(k+"Tone").textContent="â€”";
  });
  const msg=document.getElementById("msg"); msg.style.display="none";
});

/* ===== whoami â†’ userId Cookie ç™ºè¡Œï¼†ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆçŠ¶æ…‹ã®åˆæœŸåŒ– ===== */
(async function ensureUser(){
  try{ await fetch('/api/whoami'); }catch{}
  try{
    const r=await fetch('/api/credit-state');
    if(r.ok){
      const j=await r.json();
      const btnClaim=document.getElementById('btnClaim');
      const info=document.getElementById('creditInfo');
      if(j.shareBonusClaimed){
        if(btnClaim){btnClaim.disabled=true;btnClaim.textContent='ã‚·ã‚§ã‚¢ç‰¹å…¸ã¯å—ã‘å–ã‚Šæ¸ˆã¿';}
      }
      if(info) info.textContent = `ç¾åœ¨ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆï¼š${j.credits}`;
    }
  }catch{}
})();

/* ===== å†™çœŸå‡¦ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function setUpMsg(text,isErr=false){
  const el=document.getElementById('upMsg');
  el.style.display='block';
  el.style.color=isErr?'#b00020':'#b26b00';
  el.textContent=text;
}
function showSpin(v){ document.getElementById('spin').style.display = v?'flex':'none'; }

/* JSON(base64)ã§èƒŒæ™¯é™¤å»APIã‚’å‘¼ã¶ */
async function removeBgByJson(file){
  const buf=await file.arrayBuffer();
  const b64=btoa(String.fromCharCode(...new Uint8Array(buf)));
  const r=await fetch('/api/remove-bg',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ filename:file.name||'image.jpg', mime:file.type||'image/jpeg', data:b64 })
  });
  if(!r.ok){ const t=await r.text().catch(()=> ''); throw new Error(`HTTP ${r.status}: ${t.slice(0,200)}`); }
  return await r.blob(); // PNG
}
function loadImageFromBlob(blob){
  return new Promise((resolve,reject)=>{
    const url=URL.createObjectURL(blob);
    const im=new Image();
    im.onload=()=>{URL.revokeObjectURL(url);resolve(im)};
    im.onerror=e=>{URL.revokeObjectURL(url);reject(e)};
    im.src=url;
  });
}
function drawComposite(canvas,bgHex,subjectImg){
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle=bgHex; ctx.fillRect(0,0,W,H);
  const pad=.05,maxW=W*(1-2*pad),maxH=H*(1-2*pad);
  const sc=Math.min(maxW/subjectImg.width,maxH/subjectImg.height);
  const dw=subjectImg.width*sc, dh=subjectImg.height*sc;
  const dx=(W-dw)/2, dy=(H-dh)/2;
  ctx.shadowColor='rgba(0,0,0,.15)'; ctx.shadowBlur=Math.round(W*.02);
  ctx.drawImage(subjectImg,dx,dy,dw,dh); ctx.shadowBlur=0;
}
function downloadCanvas(canvas, filename){
  const dataUrl=canvas.toDataURL('image/png');
  const isIOS=/iP(hone|ad|od)/.test(navigator.platform)||(navigator.userAgent.includes('Mac') && 'ontouchend' in document);
  if(isIOS){
    const w=window.open(); if(!w) return;
    w.document.write('<html><head><title>é•·æŠ¼ã—ã§ä¿å­˜</title></head><body style="margin:0">');
    w.document.write(`<img src="${dataUrl}" style="width:100%;height:auto;display:block">`);
    w.document.write('</body></html>'); w.document.close();
  }else{
    const a=document.createElement('a'); a.href=dataUrl; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  }
}

/* ===== ç¾åœ¨ã®è¨ºæ–­HEXã‚’å–å¾— ===== */
function currentResultHexes(){
  const m=document.getElementById('mainHex')?.textContent.trim();
  const s=document.getElementById('subHex')?.textContent.trim();
  const a=document.getElementById('accHex')?.textContent.trim();
  if(!m||m==='â€”'||!s||s==='â€”'||!a||a==='â€”') return null;
  return {main:m,sub:s,acc:a};
}

/* ===== å…¥å£ï¼šã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† ===== */
const uploadEl=document.getElementById('upload');
if(uploadEl){
  uploadEl.addEventListener('change', async (e)=>{
    const file=e.target.files?.[0]; if(!file) return;

    const hexes=currentResultHexes();
    if(!hexes){ setUpMsg('å…ˆã«è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ã€3è‰²ã‚’ç¢ºå®šã—ã¦ãã ã•ã„ã€‚',true); return; }

    if(!/^image\/(png|jpeg|jpg|webp)$/i.test(file.type)){
      setUpMsg('PNG/JPG/WebP ã®ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆHEICã¯å¤‰æ›ãŒå¿…è¦ï¼‰',true); return;
    }
    if(file.size>4*1024*1024){ setUpMsg('ç”»åƒãŒå¤§ãã™ãã¾ã™ï¼ˆ4MBä»¥ä¸‹æ¨å¥¨ï¼‰',true); return; }

    try{
      setUpMsg('èƒŒæ™¯ã‚’å‰Šé™¤ä¸­â€¦'); showSpin(true);
      const cutBlob=await removeBgByJson(file);
      const subject=await loadImageFromBlob(cutBlob);

      drawComposite(document.getElementById('cvMain'),hexes.main,subject);
      drawComposite(document.getElementById('cvSub'), hexes.sub ,subject);
      drawComposite(document.getElementById('cvAcc'), hexes.acc ,subject);

      document.getElementById('previewArea').style.display='block';
      setUpMsg('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚å„ãƒœã‚¿ãƒ³ã‹ã‚‰ä¿å­˜ã§ãã¾ã™ã€‚');
    }catch(err){
      console.error(err);
      setUpMsg('èƒŒæ™¯é™¤å»ã«å¤±æ•—ã—ã¾ã—ãŸï¼š '+String(err).slice(0,300),true);
    }finally{
      showSpin(false);
    }
  });
}

/* ===== å˜å“ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ===== */
document.getElementById('dlMain')?.addEventListener('click',()=>downloadCanvas(document.getElementById('cvMain'),'main.png'));
document.getElementById('dlSub') ?.addEventListener('click',()=>downloadCanvas(document.getElementById('cvSub') ,'sub.png'));
document.getElementById('dlAcc') ?.addEventListener('click',()=>downloadCanvas(document.getElementById('cvAcc') ,'accent.png'));

/* ===== ã‚·ã‚§ã‚¢ â†’ è‡ªå·±ç”³å‘Šã§ç‰¹å…¸ï¼ˆç”Ÿæ¶¯1å›ï¼‰ ===== */
const btnShare  = document.getElementById('btnShare');
const btnClaim  = document.getElementById('btnClaim');
const creditInfo= document.getElementById('creditInfo');

btnShare?.addEventListener('click', async ()=>{
  const text='æ„›çŠ¬ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼è¨ºæ–­ã®çµæœï¼ #æ„›çŠ¬ã‚«ãƒ©ãƒ¼è¨ºæ–­ @aha_tokyo';
  try{
    if(navigator.share){
      await navigator.share({ title:'æ„›çŠ¬ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼è¨ºæ–­', text, url: location.origin });
      btnClaim.disabled=false;
      btnClaim.textContent='ã‚·ã‚§ã‚¢å®Œäº†ï¼1ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå—ã‘å–ã‚‹';
    }else{
      alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Shareã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚SNSã§æ‰‹å‹•æŠ•ç¨¿å¾Œã€ã€Œã‚·ã‚§ã‚¢å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
      btnClaim.disabled=false;
    }
  }catch(e){ /* ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ãªã©ã¯ç„¡è¦– */ }
});

btnClaim?.addEventListener('click', async ()=>{
  btnClaim.disabled = true;
  btnClaim.textContent = 'ä»˜ä¸ä¸­â€¦';
  try {
    const r = await fetch('/api/claim-share-credit', { method: 'POST' });
    const j = await r.json();
    if (r.status === 409) {
      alert(j.message || 'ã“ã®ç‰¹å…¸ã¯ãŠä¸€äººæ§˜1å›ã¾ã§ã§ã™ã€‚');
      btnClaim.textContent = 'ã‚·ã‚§ã‚¢ç‰¹å…¸ã¯å—ã‘å–ã‚Šæ¸ˆã¿';
      return;
    }
    if (j.ok) {
      creditInfo.textContent = `ğŸ‰ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’1è¿½åŠ ã—ã¾ã—ãŸï¼ˆæ®‹ï¼š${j.credits}ï¼‰`;
      btnClaim.textContent = 'ä»˜ä¸æ¸ˆã¿';
      return;
    }
    alert(j.message || 'ä»˜ä¸ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
    btnClaim.textContent = 'ã‚·ã‚§ã‚¢å®Œäº†ï¼1ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå—ã‘å–ã‚‹';
    btnClaim.disabled = false;
  } catch (e) {
    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    btnClaim.textContent = 'ã‚·ã‚§ã‚¢å®Œäº†ï¼1ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå—ã‘å–ã‚‹';
    btnClaim.disabled = false;
  }
});
</script>
</body>
</html>
