<meta http-equiv="Cache-Control" content="no-store" />
<meta name="x-build-version" content="2025-08-17-01">
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>愛犬パーソナルカラー診断</title>
<style>
  :root{--ink:#222;--muted:#667085;--bg:#f7f7f9;--panel:#fff;--brand:#2d9cdb}
  *{box-sizing:border-box}
  body{margin:0;font:15px/1.55 system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:var(--ink)}
  header{padding:18px 14px;text-align:center;background:#fff;border-bottom:1px solid #eee}
  h1{margin:0 0 6px;font-size:20px}
  .subtitle{font-size:13px;color:#666;line-height:1.5}
  .app{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:14px}
  @media(min-width:900px){.app{grid-template-columns:1.2fr 1fr}}
  .card{background:var(--panel);border:1px solid #e9eaee;border-radius:12px;padding:14px}
  h2{margin:0 0 8px;font-size:16px}
  .hint{font-size:12px;color:var(--muted);display:flex;gap:6px;align-items:flex-start}
  .hint::before{content:"ⓘ";display:inline-block;line-height:1;border-radius:50%;font-size:12px;color:#4a77a8}
  .coat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .coat{border:1px solid #e6e7eb;border-radius:10px;overflow:hidden;background:#fff;cursor:pointer}
  .coat .chip{height:46px}
  .coat .meta{padding:6px 8px;font-size:13px;display:flex;justify-content:space-between;align-items:center;gap:6px}
  .coat .meta span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0}
  .coat small{color:#6c727f}
  .coat.selected{outline:3px solid #8ccdf5;border-color:#8ccdf5}
  .traits{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  .group{border:1px solid #eee;border-radius:10px;padding:8px}
  .group h3{margin:0 0 6px;font-size:12px;color:var(--muted)}
  .traits-list label{display:flex;align-items:center;gap:6px;padding:3px 4px;border-radius:6px}
  .traits-list label:hover{background:#f6f7f9}
  .actions{display:flex;gap:8px;margin-top:10px}
  .btn{border:0;border-radius:999px;padding:9px 14px;font-weight:700;cursor:pointer}
  .primary{background:var(--brand);color:#fff}
  .ghost{background:#f1f3f5;color:#333}
  .err{color:#b00020;font-size:13px;margin-top:6px;display:none}
  .note{color:#b26b00;font-size:12px;margin-top:6px;display:none}
  .swatches{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .sw{border:1px solid #e6e6e6;border-radius:12px;overflow:hidden;background:#fff}
  .sw .chip{height:70px}
  .sw .meta{padding:8px 10px}
  .sw .ttl{font-weight:700;font-size:13px}
  .rowsm{display:flex;justify-content:space-between;align-items:center;margin-top:2px}
  .rowsm code{background:#f2f4f7;border-radius:6px;padding:2px 6px}
  .badge{display:none}

  /* preview section */
  #photoSection .bar{height:4px;border-radius:4px;overflow:hidden;background:#eee;margin-top:8px;display:none}
  #photoSection .bar > i{display:block;height:100%;width:0;background:var(--brand);transition:width .2s}
  #photoSection .spin{display:none;margin-top:8px;font-size:13px;color:#555}

  @media (max-width: 640px) {
    .app{grid-template-columns:1fr;padding:10px}
    .coat-grid{grid-template-columns:repeat(2,1fr);gap:10px}
    .coat .chip{height:56px}
    .coat .meta{font-size:12px;padding:5px 7px}
    .coat .meta small{display:none}
    .traits{grid-template-columns:1fr;gap:10px}
    .traits-list label{padding:8px 10px}
    .traits-list input[type="checkbox"]{transform:scale(1.25)}
    .actions{flex-direction:column;gap:10px}
    .btn{width:100%;padding:14px 16px;font-size:16px}
    .swatches{grid-template-columns:1fr;gap:12px}
    .sw .chip{height:84px}
    .sw .meta{padding:10px 12px}
    .rowsm code{font-size:12px}
    body{font-size:16px}
  }
  .coat,.btn,.traits-list label{min-height:44px}
</style>
</head>
<body>
<header>
  <h1>愛犬パーソナルカラー診断</h1>
  <div class="subtitle">合計27,000通りの毛色×性格の組み合わせから、愛犬に似合う3色を診断します</div>
</header>

<div class="app">
  <section class="card">
    <h2>1) 愛犬の毛色を選択</h2>
    <p class="hint">1色のみ選択してください。(毛が2色の場合はメインの色を選択)</p>
    <div id="coatGrid" class="coat-grid" aria-label="毛色一覧"></div>

    <h2 style="margin-top:14px">2) 愛犬の性格を1～3つまで選択</h2>
    <p class="hint">各カテゴリーから1つずつ選ぶことも、1つのカテゴリーから3つ選ぶこともできます</p>
    <div class="traits">
      <div class="group"><h3>内向的</h3><div id="traits-intro" class="traits-list"></div></div>
      <div class="group"><h3>中立的</h3><div id="traits-neutral" class="traits-list"></div></div>
      <div class="group"><h3>外交的</h3><div id="traits-extro" class="traits-list"></div></div>
    </div>

    <div class="actions">
      <button class="btn primary" id="run">診断する</button>
      <button class="btn ghost" id="reset">リセット</button>
    </div>
    <div id="msg" class="err"></div>
    <div id="note" class="note">性格は1〜3つまで選択してください。</div>
  </section>

  <section class="card">
    <h2>愛犬パーソナルカラー診断結果</h2>
    <p class="hint">メイン：毛色ベース / サブ：性格も加味 / アクセント：コントラスト重視</p>
    <div class="swatches">
      <div class="sw"><div class="chip" id="mainChip" style="background:#fff"></div><div class="meta"><div class="ttl">メイン</div><div class="rowsm"><span id="mainName">—</span><code id="mainHex">—</code></div></div></div>
      <div class="sw"><div class="chip" id="subChip"  style="background:#fff"></div><div class="meta"><div class="ttl">サブ</div><div class="rowsm"><span id="subName">—</span><code id="subHex">—</code></div></div></div>
      <div class="sw"><div class="chip" id="accChip"  style="background:#fff"></div><div class="meta"><div class="ttl">アクセント</div><div class="rowsm"><span id="accName">—</span><code id="accHex">—</code></div></div></div>
    </div>
  </section>
</div>

<section class="card" id="photoSection" style="margin:16px auto;max-width:1100px;">
  <h2>愛犬写真の背景除去＆3色プレビュー</h2>
  <p class="hint">画像をアップロードすると背景を自動で除去し、診断の3色背景でプレビューできます</p>

  <input id="upload" type="file" accept="image/png,image/jpeg,image/webp, image/heic, image/heif" />
  <div id="upMsg" class="note" style="margin-top:8px;display:none;"></div>
  <div class="bar" id="bar"><i></i></div>
  <div class="spin" id="spin">処理中…</div>

  <div id="previewArea" style="display:none; margin-top:12px;">
    <div style="display:grid; gap:12px;">
      <canvas id="cvMain" width="900" height="900" style="max-width:100%;border:1px solid #eee;border-radius:8px;"></canvas>
      <canvas id="cvSub"  width="900" height="900" style="max-width:100%;border:1px solid #eee;border-radius:8px;"></canvas>
      <canvas id="cvAcc"  width="900" height="900" style="max-width:100%;border:1px solid #eee;border-radius:8px;"></canvas>
    </div>
    <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn" id="dlMain" style="padding:10px 14px; border-radius:8px; border:1px solid #ddd;">メイン色背景をダウンロード</button>
      <button class="btn" id="dlSub"  style="padding:10px 14px; border-radius:8px; border:1px solid #ddd;">サブ色背景をダウンロード</button>
      <button class="btn" id="dlAcc"  style="padding:10px 14px; border-radius:8px; border:1px solid #ddd;">アクセント色背景をダウンロード</button>
    </div>
  </div>
</section>

<!-- ================== 診断ロジック（省略なし・既存でOK） ================== -->
<script>
/* ここに（あなたの）診断ロジック：PALETTE/COATS/TRAITS/pickColors/render/… をそのまま残す。
   既に動いているので省略します。エラーが出ない限りそのままでOK。 */
</script>

<!-- ============ 写真モジュール（唯一のアップロード処理） ============ -->
<script>
/*** 旧スニペット無効化（#file が残っていれば DOM から除去） ***/
document.getElementById('file')?.remove();

/*** 診断HEXを取得 ***/
function currentResultHexes(){
  const m=document.getElementById('mainHex')?.textContent.trim();
  const s=document.getElementById('subHex')?.textContent.trim();
  const a=document.getElementById('accHex')?.textContent.trim();
  if(!m||m==='—'||!s||s==='—'||!a||a==='—') return null;
  return {main:m,sub:s,acc:a};
}

/*** UIヘルパ ***/
function setUpMsg(text,isErr=false){
  const el=document.getElementById('upMsg');
  el.style.display='block';
  el.style.color=isErr?'#b00020':'#b26b00';
  el.textContent=text;
}
const bar = document.getElementById('bar');
const barI = bar.querySelector('i');
const spin = document.getElementById('spin');
function prog(p){ bar.style.display='block'; barI.style.width = Math.max(0, Math.min(100, p)) + '%'; }
function spinOn(){ spin.style.display='block'; }
function spinOff(){ spin.style.display='none'; bar.style.display='none'; }

/*** HEIC/HEIF → JPEG 変換（iOS対策・ブラウザ未対応時はそのまま） ***/
async function normalizeImageFile(file){
  try{
    // ブラウザで createImageBitmap が動けば直接 Bitmap 化（HEIC は多くのブラウザで不可）
    if ('createImageBitmap' in window) {
      let f = file;
      // MIME が heic/heif なら一度画像読み込みを試す（失敗したらそのまま返す）
      if (/image\/(heic|heif)/i.test(file.type)) {
        try {
          await createImageBitmap(file);
        } catch { return file; } // 対応してない環境はサーバでそのまま
      }
      const bmp = await createImageBitmap(f);
      // 長辺1600にリサイズ & JPEG 化（容量削減）
      const maxSide = 1600;
      const scale = Math.min(maxSide / bmp.width, maxSide / bmp.height, 1);
      const w = Math.round(bmp.width * scale);
      const h = Math.round(bmp.height * scale);
      const c = new OffscreenCanvas(w, h);
      const ctx = c.getContext('2d');
      ctx.drawImage(bmp, 0, 0, w, h);
      const blob = await c.convertToBlob({ type: 'image/jpeg', quality: 0.9 });
      return new File([blob], (file.name || 'image') + '.jpg', { type:'image/jpeg' });
    }
  }catch(e){
    console.warn('normalizeImageFile fallback:', e);
  }
  // フォールバック：そのまま
  return file;
}

/*** Blob → base64（先頭 data: を外した本体） ***/
function blobToBase64Body(blob){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>{ try{
      const s = String(fr.result || '');
      resolve(s.split(',')[1] || '');
    }catch(e){ reject(e); } };
    fr.onerror=reject;
    fr.readAsDataURL(blob);
  });
}

/*** JSON で /api/remove-bg に投げる ***/
async function removeBgByJson(file){
  // 進捗UI
  prog(5); spinOn();

  const normalized = await normalizeImageFile(file);
  prog(20);

  const b64 = await blobToBase64Body(normalized);
  prog(35);

  const r = await fetch('/api/remove-bg', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      filename: normalized.name || 'image.jpg',
      mime: normalized.type || 'image/jpeg',
      data: b64
    })
  });

  prog(70);

  if(!r.ok){
    let detail='';
    try{ detail = await r.text(); }catch{}
    throw new Error(`HTTP ${r.status}: ${detail?.slice(0,300)}`);
  }

  const blob = await r.blob(); // PNG
  prog(100);
  return blob;
}

/*** Blob → HTMLImageElement ***/
function loadImageFromBlob(blob){
  return new Promise((resolve,reject)=>{
    const url = URL.createObjectURL(blob);
    const im = new Image();
    im.onload = ()=>{ URL.revokeObjectURL(url); resolve(im); };
    im.onerror = e =>{ URL.revokeObjectURL(url); reject(e); };
    im.src = url;
  });
}

/*** 合成（単色背景＋中央フィット） ***/
function drawComposite(canvas,bgHex,subjectImg){
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle=bgHex;
  ctx.fillRect(0,0,W,H);
  const pad=.05,maxW=W*(1-2*pad),maxH=H*(1-2*pad);
  const scale=Math.min(maxW/subjectImg.width,maxH/subjectImg.height);
  const dw=subjectImg.width*scale,dh=subjectImg.height*scale;
  const dx=(W-dw)/2,dy=(H-dh)/2;
  ctx.shadowColor='rgba(0,0,0,.15)';
  ctx.shadowBlur=Math.round(W*.02);
  ctx.drawImage(subjectImg,dx,dy,dw,dh);
  ctx.shadowBlur=0;
}

/*** ダウンロード ***/
function downloadCanvas(canvas, filename){
  const dataUrl=canvas.toDataURL('image/png');
  const isIOS=/iP(hone|ad|od)/.test(navigator.platform)||
              (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
  if(isIOS){
    const w=window.open(); if(!w) return;
    w.document.write('<html><head><title>長押しで保存</title></head><body style="margin:0">');
    w.document.write(`<img src="${dataUrl}" style="width:100%;height:auto;display:block">`);
    w.document.write('</body></html>');
    w.document.close();
  }else{
    const a=document.createElement('a');
    a.href=dataUrl; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  }
}

/*** 入口：アップロード ***/
const uploadEl=document.getElementById('upload');
if(uploadEl){
  uploadEl.addEventListener('change', async (e)=>{
    const file=e.target.files?.[0]; if(!file) return;

    const hexes=currentResultHexes();
    if(!hexes){ setUpMsg('先に診断を実行して、3色を確定してください。',true); return; }

    if(!/^image\//i.test(file.type)){ setUpMsg('画像ファイルを選択してください。',true); return; }
    if(file.size>8*1024*1024){ setUpMsg('画像が大きすぎます（8MB以下推奨）',true); return; }

    try{
      setUpMsg('背景を削除中…（数秒かかります）');
      prog(2); spinOn();

      const cutBlob=await removeBgByJson(file);
      const subject=await loadImageFromBlob(cutBlob);

      drawComposite(document.getElementById('cvMain'),hexes.main,subject);
      drawComposite(document.getElementById('cvSub'), hexes.sub ,subject);
      drawComposite(document.getElementById('cvAcc'), hexes.acc ,subject);

      document.getElementById('previewArea').style.display='block';
      setUpMsg('プレビューを表示しました。各ボタンから保存できます。');
    }catch(err){
      console.error(err);
      setUpMsg('背景除去に失敗しました： '+String(err).slice(0,500),true);
    }finally{
      spinOff();
      prog(0);
    }
  });
}

/*** ダウンロードボタン ***/
document.getElementById('dlMain')?.addEventListener('click',()=>downloadCanvas(document.getElementById('cvMain'),'main.png'));
document.getElementById('dlSub') ?.addEventListener('click',()=>downloadCanvas(document.getElementById('cvSub') ,'sub.png'));
document.getElementById('dlAcc') ?.addEventListener('click',()=>downloadCanvas(document.getElementById('cvAcc') ,'accent.png'));
</script>
</body>
</html>
