// /api/remove-bg.js
import fetch from 'node-fetch';
import FormData from 'form-data';

export default async function handler(req, res) {
  try {
    if (req.method !== 'POST') {
      return res.status(405).json({ error: 'METHOD_NOT_ALLOWED' });
    }

    const apiKey = process.env.CLIPDROP_API_KEY;
    if (!apiKey) return res.status(500).json({ error: 'MISSING_API_KEY' });

    const { filename = 'image.jpg', mime = 'image/jpeg', data } = req.body || {};
    if (!data) {
      return res.status(400).json({ error: 'NO_IMAGE_DATA' });
    }

    let buffer;
    try {
      buffer = Buffer.from(data, 'base64');
    } catch (e) {
      return res.status(400).json({ error: 'INVALID_BASE64', detail: String(e) });
    }

    if (!/^image\/(png|jpe?g|webp)$/i.test(mime)) {
      return res.status(415).json({ error: 'UNSUPPORTED_TYPE', detail: mime });
    }
    if (buffer.length > 4 * 1024 * 1024) {
      return res.status(413).json({ error: 'FILE_TOO_LARGE', size: buffer.length });
    }

    const form = new FormData();
    form.append('image_file', buffer, { filename, contentType: mime });

    const r = await fetch('https://clipdrop-api.co/remove-background/v1', {
      method: 'POST',
      headers: { 'x-api-key': apiKey },
      body: form
    });

    if (!r.ok) {
      const text = await r.text();
      console.error('ClipDrop error', r.status, text);
      return res.status(502).json({ error: 'CLIPDROP_ERROR', status: r.status, detail: text });
    }

    const arrayBuffer = await r.arrayBuffer();
    res.setHeader('Content-Type', 'image/png');
    res.send(Buffer.from(arrayBuffer));
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'SERVER_ERROR', detail: String(e) });
  }
}
